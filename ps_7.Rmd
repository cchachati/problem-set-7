---
title: "Problem Set 7"
output: html_document
date: "11/18/2018"
author: Cayanne Chachati and Ghada Amer 
---

```{r setup, include=FALSE, error = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(ggplot2)
library(kableExtra)
library(rebus)
library(lubridate)
library(knitr)
library(haven)
library(scales)
library(fs)
library(janitor)
```

```{r echo = FALSE,  error = FALSE, message = FALSE, warning = FALSE}

  ## Automate the process of downloading and unzipping files 

download.file("https://goo.gl/ZRCBda","poll.zip", quiet = TRUE)
unzip("poll.zip")

file_names <- dir_ls("2018-live-poll-results-master/data")

  ## Use the map_df function to read all the files.
  ## Specify .id = source to display the source or file name next to each observation.
  ## Using str_remove_all, remove the beginning of all source names,
  ## only keeping the end part that distinguishes different files.
  ## This will make it easier to deal with the file names in the future. 

data <- map_df(file_names, read_csv, .id = "source") %>%
  mutate(source = str_remove_all(source, pattern = "2018-live-poll-results-master/data/elections-poll-"))
```

```{r}
forecast <-
  data %>%
  mutate(office_district = str_sub(source, 3, -7)) %>%
  mutate(office_district = str_remove(office_district, "^0+")) %>%

  
  mutate(state = str_sub(source, 1, 2)) %>%
  mutate(wave = str_sub(source, -5, -5)) %>%
  select(state, office_district, wave, final_weight, response)

forecast <-
forecast %>%
  filter(office_district != "gov" & office_district != "sen") %>%
  mutate(state = str_to_upper(state)) %>%
  unite(district, c("state", "office_district"), sep = "-") %>% 
  mutate(response = case_when(
           response == "Dem" ~ "Dem",
           response == "Rep" ~ "Rep",
           response == "Und" ~ "Und", 
           response == "3" ~ "3",
           response == "4" ~ "4",
           response == "5" ~ "5")) 

forecast_new <-
  forecast %>% 
  group_by(district, wave, response) %>% 
  count(wt = final_weight) %>% 
  spread(response, n, fill = 0) %>% 
  mutate(all = Dem + Rep + Und + `3` + `4` + `5`) %>% 
  mutate(adv_rep = ((Rep - Dem)/all)) %>% 
  select(district, wave, adv_rep) %>% 
  adorn_pct_formatting(digits=0)

forecast_new
  
```

```{r}
actual <- read_csv("ps_7_data_real.csv")

actual <- 
  actual %>%
  filter(district != "gov" & district != "sen") %>%
  mutate(district = str_remove(district, "^0+")) %>%
  unite(district, c("state", "district"), sep = "-") %>% 
  mutate(all_votes = `dem_votes` + `rep_votes` + `other_votes`) %>% 
  mutate(adv_rep_actual = ((`rep_votes` - `dem_votes`)/all_votes)) %>%
  adorn_pct_formatting(digits=0) %>%
  select(district, adv_rep_actual)

  
joined <- 
  inner_join(forecast_new, actual, by = "district") %>%
  mutate(adv_rep_forecast = parse_number(adv_rep),
         adv_rep_actual = parse_number(adv_rep_actual)) %>%
  select(district, wave, adv_rep_actual, adv_rep_forecast)


polled_once <- 
  joined %>%
  group_by(district) %>%
  mutate(distinct = n_distinct(wave)) %>%
  filter(distinct == 1)

polled_once

polled_twice <-
joined %>%
  group_by(district) %>%
  mutate(distinct = n_distinct(wave)) %>%
  filter(distinct == 2) %>%
  mutate(iteration = case_when(
         wave %in% c(1, 2) ~ 1,
         wave == 3 ~ 2)) %>%
  select(district, iteration, adv_rep_actual, adv_rep_forecast)

polled_twice

```




```
